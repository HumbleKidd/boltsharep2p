<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<div id="bolt-share-armor-pro">
    <nav class="armor-nav">
        <div class="nav-container">
            <div class="brand">
                <svg viewBox="0 0 24 24" class="icon-bolt"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
                <span>BoltShare PRO</span>
            </div>
            <div class="system-status">
                <span class="pulse-dot" id="pulse-indicator"></span> <span id="node-status">P2P Network Active</span>
            </div>
        </div>
    </nav>

    <main class="armor-viewport">
        <div class="dual-layout">
            <div class="card glass">
                <div class="card-header">
                    <h3>Device Link</h3>
                    <span class="badge" id="conn-status">Standby</span>
                </div>
                
                <div class="qr-container">
                    <div id="qr-display" class="qr-view active">
                         <div id="real-qr-target"></div>
                         <p class="qr-label">SCAN TO SYNC FILES</p>
                    </div>
                    <div id="scanner-view" class="qr-view">
                        <div id="interactive-reader" style="width: 100%;"></div>
                    </div>
                </div>

                <div class="qr-toggle-bar">
                    <button class="btn-mini" onclick="BoltPro.toggleScanner(false)">My QR</button>
                    <button class="btn-mini" onclick="BoltPro.toggleScanner(true)">Scan Peer</button>
                </div>

                <div class="input-stack">
                    <input type="text" id="peer-id-input" placeholder="Paste Peer ID...">
                    <button class="btn-glow" onclick="BoltPro.connectToPeer()">Link</button>
                </div>
                <p class="meta-text">My ID: <strong id="my-id">...</strong> <button class="btn-mini" onclick="BoltPro.copyID()">Copy</button></p>
            </div>

            <div class="card glass">
                <h3>Rapid Upload</h3>
                <div class="drop-target" id="drop-target" onclick="document.getElementById('file-engine').click()">
                    <input type="file" id="file-engine" hidden multiple onchange="BoltPro.stageFiles(this.files)">
                    <div class="icon-circle">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="icon-up">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" x1="3" x2="12" y2="15"></line>
                        </svg>
                    </div>
                    <p style="margin-top:15px; font-weight:700; color: var(--primary);">DROP FILES OR CLICK</p>
                </div>
            </div>
        </div>

        <div class="active-queue-header">Live Assets Feed</div>
        <div id="transfer-queue" class="queue-list"></div>
    </main>

    <div id="preview-modal" class="modal" onclick="BoltPro.closePreview()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="preview-body" class="media-container"></div>
            <div class="modal-actions">
                <button class="btn-glow" id="modal-dl-btn">Download Now</button>
                <button class="btn-sec" onclick="BoltPro.closePreview()">Close</button>
            </div>
        </div>
    </div>
</div>

<style>
#bolt-share-armor-pro { --primary: #00f2ff; --bg-deep: #05070a; --glass: rgba(255, 255, 255, 0.05); --border: rgba(255, 255, 255, 0.1); --text: #e2e8f0; background: var(--bg-deep); color: var(--text); min-height: 100vh; font-family: sans-serif; overflow-x: hidden; }
.armor-nav { background: rgba(10, 15, 25, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
.nav-container { max-width: 1100px; margin: 0 auto; padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; }
.brand { display: flex; align-items: center; gap: 8px; font-weight: 800; color: var(--primary); }
.icon-bolt { width: 24px; fill: var(--primary); }
.pulse-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; display: inline-block; box-shadow: 0 0 10px #22c55e; }
.armor-viewport { max-width: 1100px; margin: 0 auto; padding: 2rem 1.5rem; }
.dual-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2.5rem; }
.card.glass { background: var(--glass); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; }
.qr-container { height: 210px; background: #fff; border-radius: 12px; margin: 1rem 0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
#real-qr-target img { width: 150px !important; height: 150px !important; }
.qr-view { display: none; width: 100%; height: 100%; align-items: center; justify-content: center; flex-direction: column; }
.qr-view.active { display: flex; }
.qr-label { color: #000; font-size: 10px; font-weight: 900; margin-top: 8px; }
.drop-target { height: 240px; border: 2px dashed var(--border); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
.icon-circle { width: 64px; height: 64px; background: rgba(0, 242, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); }
.transfer-strip { background: var(--glass); padding: 16px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; border: 1px solid var(--border); }
.instant-actions { display: flex; gap: 10px; }
.btn-action, .btn-mini { background: var(--primary); color: #000; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 700; cursor: pointer; }
.btn-mini { background: var(--glass); color: #fff; border: 1px solid var(--border); }
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.98); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal-content { background: #111; border-radius: 20px; width: 90%; max-width: 900px; border: 1px solid var(--border); overflow: hidden; }
.media-container { width: 100%; height: 60vh; display: flex; align-items: center; justify-content: center; background: #000; }
.media-container iframe, .media-container img, .media-container video { max-width: 100%; max-height: 100%; width: 100%; height: 100%; border: none; object-fit: contain; }
.modal-actions { padding: 20px; display: flex; justify-content: center; gap: 15px; }
.btn-glow { background: var(--primary); color: #000; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; }
.btn-sec { background: transparent; border: 1px solid var(--border); color: #fff; padding: 12px 24px; border-radius: 8px; cursor: pointer; }
.badge { background: var(--primary); color: #000; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 900; }

@media (max-width: 768px) {
    .dual-layout { grid-template-columns: 1fr; gap: 1rem; }
    .armor-viewport { padding: 1rem; }
    .transfer-strip div:first-child { max-width: 50%; overflow: hidden; }
}
</style>

<script>
const BoltPro = (() => {
    let peer = null, conn = null, html5QrCode = null, db = null;
    const cache = new Map();

    const init = async () => {
        await setupDB();
        setupPeer();
        loadHistory();
        setInterval(autoPurge, 30000); 
    };

    const setupDB = () => {
        return new Promise((resolve) => {
            const req = indexedDB.open("BoltPersistence_Final", 1);
            req.onupgradeneeded = (e) => e.target.result.createObjectStore("files", { keyPath: "id" });
            req.onsuccess = (e) => { db = e.target.result; resolve(); };
        });
    };

    const setupPeer = () => {
        const peerId = 'BOLT-' + Math.floor(Math.random() * 90000 + 10000);
        peer = new Peer(peerId, { debug: 1 });
        
        peer.on('open', id => {
            document.getElementById('my-id').innerText = id;
            const shareUrl = window.location.href.split('?')[0] + '?peer=' + id;
            document.getElementById('real-qr-target').innerHTML = "";
            new QRCode(document.getElementById('real-qr-target'), { text: shareUrl, width: 150, height: 150 });
            
            const urlParams = new URLSearchParams(window.location.search);
            if(urlParams.get('peer')) connectToPeer(urlParams.get('peer'));
        });

        // Listen for incoming connections (Device A)
        peer.on('connection', c => {
            conn = c;
            setupConnHandlers();
        });
    };

    const setupConnHandlers = () => {
        document.getElementById('conn-status').innerText = "LINKED";
        document.getElementById('conn-status').style.background = "#22c55e";

        // When a connection is established, Device A (source) sends its list
        // And Device B (receiver) sends its list. This ensures bidirectional sync.
        syncLocalList();

        conn.on('data', data => {
            if (data.type === 'SYNC_LIST') {
                data.files.forEach(f => {
                    if (!cache.has(f.id)) {
                        cache.set(f.id, f);
                        renderItem(f, true);
                    }
                });
            }
            if (data.type === 'REQ_DATA') {
                const item = cache.get(data.id);
                if (item && item.raw) {
                    conn.send({ type: 'SEND_DATA', id: item.id, raw: item.raw, name: item.name, itemType: item.type });
                }
            }
            if (data.type === 'SEND_DATA') {
                const blob = new Blob([data.raw], { type: data.itemType });
                const url = URL.createObjectURL(blob);
                const item = { ...data, data: url, raw: blob, time: Date.now() };
                cache.set(data.id, item);
                saveToDB(item);
                openPreview(data.id);
            }
        });
    };

    const syncLocalList = () => {
        if (!conn || !conn.open) return;
        const list = Array.from(cache.values()).map(f => ({ 
            id: f.id, name: f.name, type: f.type, isHTML: f.isHTML, isText: f.isText, time: f.time 
        }));
        conn.send({ type: 'SYNC_LIST', files: list });
    };

    const loadHistory = () => {
        const tx = db.transaction("files", "readonly");
        tx.objectStore("files").openCursor().onsuccess = (e) => {
            const cursor = e.target.result;
            if (cursor) {
                const item = cursor.value;
                item.data = URL.createObjectURL(item.raw);
                cache.set(item.id, item);
                renderItem(item);
                cursor.continue();
            }
        };
    };

    const saveToDB = (item) => {
        const tx = db.transaction("files", "readwrite");
        tx.objectStore("files").put({ ...item, data: null });
    };

    const stageFiles = async (files) => {
        for (const file of Array.from(files)) {
            const id = 'f' + Date.now() + Math.random().toString(36).substr(2,3);
            const isHTML = file.name.endsWith('.html');
            const isText = file.type.startsWith('text/') && !isHTML;
            const item = { id, name: file.name, type: file.type, data: URL.createObjectURL(file), raw: file, isHTML, isText, time: Date.now() };
            cache.set(id, item);
            saveToDB(item);
            renderItem(item);
            syncLocalList(); // Immediate broadcast of new file
        }
    };

    const autoPurge = () => {
        const now = Date.now();
        const tx = db.transaction("files", "readwrite");
        const store = tx.objectStore("files");
        cache.forEach((item, id) => {
            if (now - item.time > 600000) { // 10 Min
                store.delete(id);
                cache.delete(id);
                document.getElementById('strip-' + id)?.remove();
            }
        });
    };

    const connectToPeer = (id) => {
        const target = id || document.getElementById('peer-id-input').value;
        if(!target) return;
        if (conn) conn.close();
        conn = peer.connect(target);
        conn.on('open', () => {
            setupConnHandlers();
        });
    };

    const toggleScanner = async (on) => {
        const sv = document.getElementById('scanner-view'), dv = document.getElementById('qr-display');
        if(on) {
            dv.classList.remove('active'); sv.classList.add('active');
            html5QrCode = new Html5Qrcode("interactive-reader");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (text) => {
                const id = text.includes('?peer=') ? text.split('?peer=')[1] : text;
                connectToPeer(id);
                toggleScanner(false);
            });
        } else { if(html5QrCode) await html5QrCode.stop(); sv.classList.remove('active'); dv.classList.add('active'); }
    };

    const renderItem = (item, isRemote = false) => {
        if (document.getElementById(`strip-${item.id}`)) return;
        const html = `
            <div class="transfer-strip" id="strip-${item.id}">
                <div><div style="font-weight:700; color:var(--primary)">${item.name}</div><div style="font-size:10px; opacity:0.5">${isRemote ? 'Cloud Bridge' : 'Local Archive'}</div></div>
                <div class="instant-actions">
                    <button class="btn-action" onclick="BoltPro.openPreview('${item.id}')">OPEN</button>
                    <button class="btn-action" style="background:#fff" onclick="BoltPro.downloadFile('${item.id}')">GET</button>
                </div>
            </div>`;
        document.getElementById('transfer-queue').insertAdjacentHTML('afterbegin', html);
    };

    const openPreview = (id) => {
        const item = cache.get(id);
        if(!item) return;
        if(!item.data && conn) { conn.send({ type: 'REQ_DATA', id }); return; }
        const body = document.getElementById('preview-body');
        body.innerHTML = '';
        if (item.isHTML) body.innerHTML = `<iframe src="${item.data}" style="background:#fff"></iframe>`;
        else if (item.type.startsWith('image/')) body.innerHTML = `<img src="${item.data}">`;
        else if (item.type.startsWith('video/')) body.innerHTML = `<video controls autoplay src="${item.data}"></video>`;
        else body.innerHTML = `<iframe src="${item.data}"></iframe>`;
        document.getElementById('preview-modal').style.display = 'flex';
    };

    init();
    return { stageFiles, openPreview, toggleScanner, connectToPeer,
        closePreview: () => { document.getElementById('preview-modal').style.display = 'none'; document.getElementById('preview-body').innerHTML = ''; },
        copyID: () => { navigator.clipboard.writeText(document.getElementById('my-id').innerText); alert("ID Copied"); },
        downloadFile: (id) => { 
            const item = cache.get(id); 
            if(!item.data && conn) { conn.send({ type: 'REQ_DATA', id }); return; }
            const a = document.createElement('a'); a.href = item.data; a.download = item.name; a.click(); 
        }
    };
})();
</script>
